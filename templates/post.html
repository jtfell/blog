<div class="e-content">$body$</div>

<section>
	<h2>Webmentions</h2>
	<div id="webmentions"></div>
</section>

<footer class="flex items-baseline max-width-4 mx-auto px3 py4">
    <a class="u-url h6 bold caps black" href="$url$">
      Published <time class="dt-published">$date$</time>
    </a> //
    <a href="/" class="h6 bold caps black">Blog Home</a>
</footer>

<a href="https://brid.gy/publish/twitter"></a>

<script>
const container = document.querySelector("#webmentions");

if (container) {
  renderWebmentions(container);
}

async function renderWebmentions(container) {
  const webmentions = await getWebmentions(window.location.href);

  if (webmentions.length === 0) {
    return;
  }

  const list = document.createElement("ul");
  list.className = "webmentions";

  webmentions.forEach(webmention => {
    list.appendChild(renderWebmention(webmention));
  });

  container.appendChild(list);
}

function getWebmentions(target) {
  return fetch('https://webmention.io/api/mentions.jf2?target=' + target)
    .then(response => response.json())
    .then(data => data.children);
}

function renderWebmention(webmention) {
  const action = {
    "in-reply-to": "replied",
    "like-of": "liked",
    "repost-of": "reposted",
    "mention-of": "mentioned"
  }[webmention["wm-property"]];

  const rendered = document.importNode(
    document.getElementById("webmention-template").content,
    true
  );

  function set(selector, attribute, value) {
    rendered.querySelector(selector)[attribute] = value;
  }

  set(".webmention-author", "href", webmention.author.url || webmention.url);
  set(".webmention-author-avatar", "src", webmention.author.photo);
  set(".webmention-author-avatar", "alt", 'Photo of ' + webmention.author.name);
  set(".webmention-author-name", "textContent", webmention.author.name);
  set(".webmention-action", "href", webmention.url);

  set(
    ".webmention-action",
    "textContent",
    action + ' on ' + webmention["wm-received"].substr(0, 10)
  );

  if (webmention.content) {
    set(
      ".webmention-content",
      "innerHTML",
      webmention.content.html || webmention.content.text
    );
  }

  return rendered;
}
</script>
